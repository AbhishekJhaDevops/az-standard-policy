name: Deploy Azure Policy Definition Sets

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment Environment'
        required: true
        default: 'dev'
        type: choice
        options:
        - dev
        - test
        - prod
      target_management_group_id:
        description: 'Target Management Group ID (where definition sets will be deployed)'
        required: true
        type: string
      source_management_group_id:
        description: 'Source Management Group ID (where custom policy definitions are stored)'
        required: false
        type: string
      policy_definition_prefix:
        description: 'Custom Policy Definition Prefix'
        required: true
        default: 'DFC'
        type: string
      definition_sets_to_deploy:
        description: 'Definition sets to deploy (comma-separated, e.g., CDS001,CDS002 or "all" for all)'
        required: true
        default: 'all'
        type: string

  push:
    branches:
      - main
    paths:
      - 'policyDefinitionSet.bicep'
      - 'Params/DefinitionSet/**'

env:
  AZURE_RESOURCE_MANAGER_CONNECTION_NAME: ${{ secrets.AZURE_SERVICE_CONNECTION }}
  MANAGEMENT_GROUP_PREFIX: '/providers/Microsoft.Management/managementGroups/'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Azure CLI
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Bicep Templates
        run: |
          az bicep build --file policyDefinitionSet.bicep
          echo "âœ… Bicep template validation successful"

      - name: Validate Custom Policies Exist
        run: |
          SOURCE_MGMT_GROUP_ID="${{ github.event.inputs.source_management_group_id || github.event.inputs.target_management_group_id || vars.DEFAULT_MANAGEMENT_GROUP_ID }}"
          
          echo "ðŸ” Checking if required custom policies exist in source management group: $SOURCE_MGMT_GROUP_ID"
          CUSTOM_POLICIES=$(az policy definition list --management-group $SOURCE_MGMT_GROUP_ID --query "[?policyType=='Custom'].name" --output tsv)
          
          if [[ -z "$CUSTOM_POLICIES" ]]; then
            echo "âš ï¸ Warning: No custom policies found in source management group."
            echo "Available built-in policies will still work for definition sets."
          else
            echo "âœ… Found custom policies: $CUSTOM_POLICIES"
          fi

  deploy-definition-sets:
    needs: validate
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'dev' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Set Variables
        run: |
          TARGET_MGMT_GROUP_ID="${{ github.event.inputs.target_management_group_id || vars.DEFAULT_MANAGEMENT_GROUP_ID }}"
          SOURCE_MGMT_GROUP_ID="${{ github.event.inputs.source_management_group_id || github.event.inputs.target_management_group_id || vars.DEFAULT_MANAGEMENT_GROUP_ID }}"
          echo "TARGET_MANAGEMENT_GROUP_SCOPE=${{ env.MANAGEMENT_GROUP_PREFIX }}${TARGET_MGMT_GROUP_ID}" >> $GITHUB_ENV
          echo "SOURCE_MANAGEMENT_GROUP_SCOPE=${{ env.MANAGEMENT_GROUP_PREFIX }}${SOURCE_MGMT_GROUP_ID}" >> $GITHUB_ENV
          echo "POLICY_DEF_PREFIX=${{ github.event.inputs.policy_definition_prefix || 'DFC' }}" >> $GITHUB_ENV

      - name: Generate Dynamic Parameter File
        run: |
          cd Params/DefinitionSet
          SETS_TO_DEPLOY="${{ github.event.inputs.definition_sets_to_deploy || 'all' }}"
          
          # Start creating the bicepparam file
          echo "using '../../policyDefinitionSet.bicep'" > dynamic-definition-sets.bicepparam
          echo "" >> dynamic-definition-sets.bicepparam
          echo "param managementGroupName = '${{ env.SOURCE_MANAGEMENT_GROUP_SCOPE }}'" >> dynamic-definition-sets.bicepparam
          echo "param policyDefinitionPrefix = '${{ env.POLICY_DEF_PREFIX }}'" >> dynamic-definition-sets.bicepparam
          echo "param PolicySetDefinitionsArray = [" >> dynamic-definition-sets.bicepparam
          
          if [[ "$SETS_TO_DEPLOY" == "all" ]]; then
            # Deploy all definition sets - NO COMMAS between objects
            for file in CDS*.json; do
              if [[ -f "$file" ]]; then
                echo "  {" >> dynamic-definition-sets.bicepparam
                echo "    libSetDefinition: loadJsonContent('$file')" >> dynamic-definition-sets.bicepparam
                echo "  }" >> dynamic-definition-sets.bicepparam
              fi
            done
          else
            # Deploy specific definition sets - NO COMMAS between objects
            IFS=',' read -ra SETS_ARRAY <<< "$SETS_TO_DEPLOY"
            for set in "${SETS_ARRAY[@]}"; do
              set=$(echo "$set" | xargs) # trim whitespace
              if [[ -f "${set}.json" ]]; then
                echo "  {" >> dynamic-definition-sets.bicepparam
                echo "    libSetDefinition: loadJsonContent('${set}.json')" >> dynamic-definition-sets.bicepparam
                echo "  }" >> dynamic-definition-sets.bicepparam
              else
                echo "âš ï¸ Warning: ${set}.json not found"
              fi
            done
          fi
          
          # Close the array
          echo "]" >> dynamic-definition-sets.bicepparam
          
          echo "ðŸ“„ Generated parameter file:"
          cat dynamic-definition-sets.bicepparam

      - name: Deploy Policy Definition Sets
        run: |
          az deployment mg create \
            --management-group-id ${{ github.event.inputs.target_management_group_id || vars.DEFAULT_MANAGEMENT_GROUP_ID }} \
            --template-file policyDefinitionSet.bicep \
            --parameters Params/DefinitionSet/dynamic-definition-sets.bicepparam \
            --name "policy-definition-sets-$(date +%Y%m%d-%H%M%S)" \
            --location "East US"

      - name: Verification
        run: |
          TARGET_ID="${{ github.event.inputs.target_management_group_id || vars.DEFAULT_MANAGEMENT_GROUP_ID }}"
          echo "âœ… Policy definition sets deployed successfully to ${{ env.TARGET_MANAGEMENT_GROUP_SCOPE }}"
          echo "ðŸ“‹ Definition sets reference custom policies from: ${{ env.SOURCE_MANAGEMENT_GROUP_SCOPE }}"
          az policy set-definition list --management-group $TARGET_ID --query "[?policyType=='Custom'].{Name:name,DisplayName:displayName}" --output table